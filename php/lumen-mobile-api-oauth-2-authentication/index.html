<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>基于Lumen搭建一个OAUTH2认证的API框架 | BiBiHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta name="keywords" content="php, lumen, oauth2, api, dingo/api, oauth2-server-laravel, oauth2-server-lumen,全栈,敏捷教练,敏捷顾问,张晓亮,暴风影音,亚信,联创,中国联通,玉器贷,电网金融,Web,前端,JavaScript,html5,css3,php,java">
  

  <meta name="description" content="PHP的Lumen-Framework是为速度而生的Laravel框架，相对于Laravel来说，更适合做移动API开发，本教程会一步步的教大家，整合第三方Package，来搭建一个OAUTH2认证的API工程">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Lumen搭建一个OAUTH2认证的API框架">
<meta property="og:url" content="http://www.bibihub.com/php/lumen-mobile-api-oauth-2-authentication/index.html">
<meta property="og:site_name" content="BiBiHub">
<meta property="og:description" content="PHP的Lumen-Framework是为速度而生的Laravel框架，相对于Laravel来说，更适合做移动API开发，本教程会一步步的教大家，整合第三方Package，来搭建一个OAUTH2认证的API工程">
<meta property="og:image" content="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/lumen-welcome.png">
<meta property="og:image" content="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-401.png">
<meta property="og:image" content="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-oauth.png">
<meta property="og:image" content="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-oauth-pass.png">
<meta property="og:image" content="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-version-unknown.png">
<meta property="og:updated_time" content="2016-02-01T09:48:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于Lumen搭建一个OAUTH2认证的API框架">
<meta name="twitter:description" content="PHP的Lumen-Framework是为速度而生的Laravel框架，相对于Laravel来说，更适合做移动API开发，本教程会一步步的教大家，整合第三方Package，来搭建一个OAUTH2认证的API工程">
  
  
    <link rel="icon" href="/images/favicon.png">
  
  
 <link href='//fonts.useso.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
 <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">


  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?98ce8077b23c5e1a4bab7cffadbc6e04";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  

  

  
</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo" style="background-image: url(/images/logo.png)"></i><span class="site-title">BiBiHub</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">主页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/categories">分类</a>
        
          <a class="main-nav-link" href="/tags">标签</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/images/avatar.png"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        
          <form class="search-form">
            <input type="text" class="st-default-search-input search-form-input" placeholder="搜索">
            <button type="submit" class="search-form-submit"></button>
          </form>
        
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/.">主页</a></td>
        
          <td><a class="main-nav-link" href="/archives">归档</a></td>
        
          <td><a class="main-nav-link" href="/categories">分类</a></td>
        
          <td><a class="main-nav-link" href="/tags">标签</a></td>
        
          <td><a class="main-nav-link" href="/about">关于</a></td>
        
        <td>
          
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="搜索"><input type="hidden" name="sitesearch" value="http://www.bibihub.com"></form>
          
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="/images/avatar.png">
      <h2 id="name">张晓亮</h2>
      <h3 id="title">全栈开发 &amp; 敏捷顾问</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Beijing, China</span>
      <a id="follow" href="https://github.com/toadgg/">关注我</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        4
        <span>文章</span>
      </div>
      <div class="article-info-block">
        14
        <span>标签</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="http://github.com/toadgg/bibihub" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="https://twitter.com/toadgg" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
          
          <td><a href="https://www.facebook.com/profile.php?id=100010994202897" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
          
          <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main"><article id="post-lumen-mobile-api-oauth-2-authentication" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      
	
		<img src="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/develope-api.gif" class="article-banner">
	



    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      基于Lumen搭建一个OAUTH2认证的API框架
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/php/lumen-mobile-api-oauth-2-authentication/">
      <time datetime="2016-01-29T08:55:02.000Z" itemprop="datePublished">2016-01-29</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <blockquote><p>PHP的Lumen-Framework是为速度而生的Laravel框架，相对于Laravel来说，更适合做移动API开发，本教程会一步步的教大家，如何搭建一个OAUTH2认证的API工程，我们要在Lumen框架上，整合dingoapi与oauth2-server-laravel这两个工程</p>
<footer><strong>BiBiHub</strong><cite><a href="http://www.bibihub.com/php/lumen-mobile-api-oauth-2-authentication/">基于PHP(Lumen)搭建一个OAUTH2认证的API框架</a></cite></footer></blockquote>
<a id="more"></a>
<h2 id="u51C6_u5907_u5DE5_u4F5C"><a href="#u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="准备工作"></a>准备工作</h2><p>在开始本教程前，你需要安装PHP的运行环境，请确保你的环境满足如下条件</p>
<pre><code>1. PHP &gt;= 5.5.9
2. OpenSSL PHP Extension
3. Mbstring PHP Extension
4. Tokenizer PHP Extension
</code></pre><p>然后你需要安装<a href="http://getcomposer.org" target="_blank" rel="external">Composer</a>，确保composer在你的环境变量下，在命令行里面输入<code>composer about</code>验证一下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ bibihub$ composer about</span><br><span class="line">Composer - Package Management <span class="keyword">for</span> PHP</span><br><span class="line">Composer is a dependency manager tracking <span class="built_in">local</span> dependencies of your projects and libraries.</span><br><span class="line">See https://getcomposer.org/ <span class="keyword">for</span> more information.</span><br></pre></td></tr></table></figure></p>
<h2 id="u5B89_u88C5_Lumen"><a href="#u5B89_u88C5_Lumen" class="headerlink" title="安装 Lumen"></a>安装 Lumen</h2><p>本教程基于lumen5.1，请务必安装此版本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project laravel/lumen --prefer-dist lumen-api-starter <span class="string">"5.1.*"</span></span><br></pre></td></tr></table></figure></p>
<p>安装完成后<code>cd</code>到<code>lumen-api-starter</code>文件夹下，复制<code>.env.example</code>重命名为<code>.env</code>进行设置，APP_KEY必须是32位的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=<span class="built_in">local</span></span><br><span class="line">APP_DEBUG=<span class="literal">true</span></span><br><span class="line">APP_KEY=U&lt;CdJu~T&amp;.g/B1B1Hu8h]HfB+bb,b7Y*</span><br><span class="line"></span><br><span class="line">APP_LOCALE=en</span><br><span class="line">APP_FALLBACK_LOCALE=en</span><br><span class="line"></span><br><span class="line">DB_CONNECTION=mysql</span><br><span class="line">DB_HOST=localhost</span><br><span class="line">DB_PORT=<span class="number">3306</span></span><br><span class="line">DB_DATABASE=lumen_api_starter</span><br><span class="line">DB_USERNAME=root</span><br><span class="line">DB_PASSWORD=</span><br></pre></td></tr></table></figure></p>
<p>接下来，修改<code>bootstrap\app.php</code>文件，打开这个注释，告诉lumen，我们的配置是通过<code>.evn</code>文件控制的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Dotenv::load(__DIR__.&#39;/../&#39;);&#10;Dotenv::load(__DIR__.&#39;/../&#39;);</span><br></pre></td></tr></table></figure></p>
<h2 id="u9A8C_u8BC1Lumen_u5B89_u88C5_u6210_u529F"><a href="#u9A8C_u8BC1Lumen_u5B89_u88C5_u6210_u529F" class="headerlink" title="验证Lumen安装成功"></a>验证Lumen安装成功</h2><p>在工程的根目录下，执行命令<code>--port=8000</code>是默认的参数，你可以通过此参数修改应用的端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan serve --port=<span class="number">8000</span></span><br></pre></td></tr></table></figure></p>
<p>这个命令可以方便的启动一个server，方便开发时候调试，由于本教程重点不是部署，这里就不介绍nginx，或者apache的配置方法了，当你看到下面的提示时，标示应用启动成功了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lumen development server started on http://localhost:<span class="number">8000</span>/</span><br></pre></td></tr></table></figure></p>
<p>打开浏览器，输入<a href="http://localhost:8000/，如果你看到如下界面，恭喜你，Lumen安装成功了" target="_blank" rel="external">http://localhost:8000/，如果你看到如下界面，恭喜你，Lumen安装成功了</a></p>
<p><img src="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/lumen-welcome.png" alt="Lumen安装成功页面"></p>
<h2 id="u6DFB_u52A0_RESTful_API__u529F_u80FD"><a href="#u6DFB_u52A0_RESTful_API__u529F_u80FD" class="headerlink" title="添加 RESTful API 功能"></a>添加 RESTful API 功能</h2><p>这里我要集成”<a href="http://github.com/dingo/api" target="_blank" rel="external">dingoapi</a>“这个package，在github上，这个项目是这样描述的</p>
<blockquote><h3 id="This_package_provides_tools_for_the_following_2C_and_more_3A"><a href="#This_package_provides_tools_for_the_following_2C_and_more_3A" class="headerlink" title="This package provides tools for the following, and more:"></a>This package provides tools for the following, and more:</h3><p>Content Negotiation<br>Multiple Authentication Adapters<br>API Versioning<br>Rate Limiting<br>Response Transformers and Formatters<br>Error and Exception Handling<br>Internal Requests<br>API Blueprint Documentation</p>
<footer><strong>dingoapi</strong><cite><a href="https://github.com/dingo/api" target="_blank" rel="external">A RESTful API package for the Laravel and Lumen frameworks.</a></cite></footer></blockquote>
<p>首先，编辑我们工程下的<code>composer.json</code>文件，添加依赖然后执行<code>composer update</code>命令，这里我用版本为<code>0.10.0</code><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"require": &#123;</span><br><span class="line">    "php": "&gt;=5.5.9",</span><br><span class="line">    "laravel/lumen-framework": "5.1.*",</span><br><span class="line">    "vlucas/phpdotenv": "~1.0",</span><br><span class="line">    "dingo/api": "0.10.*" ＃add dingoapi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>composer update</code>命令执行完后，我们需要做一些配置</p>
<h4 id="u7B2C_u4E00_u79CD_u914D_u7F6E_u65B9_u6CD5"><a href="#u7B2C_u4E00_u79CD_u914D_u7F6E_u65B9_u6CD5" class="headerlink" title="第一种配置方法"></a>第一种配置方法</h4><p>编辑 .env 文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">API_STANDARDS_TREE=vnd&#10;API_VENDOR=bibihub&#10;API_PREFIX=api&#10;#API_DOMAIN=api.bibihub.com&#10;API_VERSION=v1&#10;API_NAME=lumen.api.starter&#10;API_CONDITIONAL_REQUEST=true&#10;API_STRICT=false&#10;API_DEBUG=true</span><br></pre></td></tr></table></figure></p>
<h4 id="u7B2C_u4E8C_u79CD_u65B9_u5F0F"><a href="#u7B2C_u4E8C_u79CD_u65B9_u5F0F" class="headerlink" title="第二种方式"></a>第二种方式</h4><p>在我们工程的根目录下面，创建<code>config</code>文件夹，把<code>vendor\dingo\api\config\api.php</code>文件拷贝过去。然后修改<code>bootstrap\app.php</code>文件，添加下面这条语句，这样在应用启动的时候，api的相关配置就会起作用了<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;configure(<span class="string">'api'</span>);</span><br></pre></td></tr></table></figure></p>
<p>打开<code>bootstrap\app.php</code>文件，<code>register</code>需要的<code>service provider</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;register(Dingo\Api\Provider\LumenServiceProvider::class);</span><br></pre></td></tr></table></figure>
<p>打开<code>app\Http\routes.php</code>文件，创建API的Endpoints，添加一个测试的api<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$api</span> = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line"><span class="variable">$api</span>-&gt;version(<span class="string">'v1'</span>, [], <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$api</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$api</span>-&gt;get(<span class="string">'stats'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'stats'</span> =&gt; <span class="string">'dingoapi is ok'</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>访问<code>http://localhost:8000/api/stats</code>，看到下面信息，恭喜你，<a href="http://github.com/dingo/api" target="_blank" rel="external">dingoapi</a>已经集成成功了<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	stats: "dingoapi is ok"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u6DFB_u52A0_OAUTH2__u529F_u80FD"><a href="#u6DFB_u52A0_OAUTH2__u529F_u80FD" class="headerlink" title="添加 OAUTH2 功能"></a>添加 OAUTH2 功能</h2><p>这里我要集成”<a href="http://github.com/lucadegasperi/oauth2-server-laravel" target="_blank" rel="external">oauth2-server-laravel</a>“这个package，在github上，这个项目是这样描述的</p>
<blockquote><p>OAuth 2.0 authorization server and resource server for the Laravel and Lumen frameworks. Standard compliant thanks to the amazing work by The League of Extraordinary Packages OAuth 2.0 authorization server and resource server.</p>
<footer><strong>oauth2-server-laravel</strong><cite><a href="http://github.com/lucadegasperi/oauth2-server-laravel" target="_blank" rel="external">An OAuth 2.0 bridge for Laravel and Lumen.</a></cite></footer></blockquote>
<p>首先，编辑我们工程下的<code>composer.json</code>文件，添加依赖然后执行<code>composer update</code>命令<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"require": &#123;</span><br><span class="line">    "php": "&gt;=5.5.9",</span><br><span class="line">    "laravel/lumen-framework": "5.1.*",</span><br><span class="line">    "vlucas/phpdotenv": "~1.0",</span><br><span class="line">    "dingo/api": "0.10.*",</span><br><span class="line">    "lucadegasperi/oauth2-server-laravel": "^5.0" #add</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>composer update</code>命令执行完后，我们需要做一些配置<br>打开<code>bootstrap\app.php</code>文件，<code>register</code>需要的<code>service provider</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;register(\LucaDegasperi\OAuth2Server\Storage\FluentStorageServiceProvider::class);</span><br><span class="line"><span class="variable">$app</span>-&gt;register(\LucaDegasperi\OAuth2Server\OAuth2ServerServiceProvider::class);</span><br></pre></td></tr></table></figure>
<p>还有<code>middleware</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;middleware([</span><br><span class="line">    \LucaDegasperi\OAuth2Server\Middleware\OAuthExceptionHandlerMiddleware::class</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>接下来是<code>route middleware</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;routeMiddleware([</span><br><span class="line">    <span class="string">'check-authorization-params'</span> =&gt; \LucaDegasperi\OAuth2Server\Middleware\CheckAuthCodeRequestMiddleware::class,</span><br><span class="line">    <span class="string">'csrf'</span> =&gt; \Laravel\Lumen\Http\Middleware\VerifyCsrfToken::class,</span><br><span class="line">    <span class="string">'oauth'</span> =&gt; \LucaDegasperi\OAuth2Server\Middleware\OAuthMiddleware::class,</span><br><span class="line">    <span class="string">'oauth-client'</span> =&gt; \LucaDegasperi\OAuth2Server\Middleware\OAuthClientOwnerMiddleware::class,</span><br><span class="line">    <span class="string">'oauth-user'</span> =&gt; \LucaDegasperi\OAuth2Server\Middleware\OAuthUserOwnerMiddleware::class,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure></p>
<p>拷贝<code>vendor/lucadegasperi/oauth2-server-laravel/config/oauth2.php</code>到自己的工程<code>config/oauth2.php</code>下，用<code>$app-&gt;configure()</code>注册配置文件<code>bootstrap\app.php</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app-&#62;configure(&#39;oauth2&#39;);</span><br></pre></td></tr></table></figure></p>
<p>编辑<code>config/oauth2.php</code>配置文件，我们用<code>password</code>的形式进行用户验证<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'grant_types'</span> =&gt; [</span><br><span class="line">    <span class="string">'password'</span> =&gt; [</span><br><span class="line">        <span class="string">'class'</span> =&gt; <span class="string">'\League\OAuth2\Server\Grant\PasswordGrant'</span>,</span><br><span class="line">        <span class="string">'callback'</span> =&gt; <span class="string">'\App\PasswordGrantVerifier@verify'</span>,</span><br><span class="line">        <span class="string">'access_token_ttl'</span> =&gt; <span class="number">3600</span></span><br><span class="line">    ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>创建一个class，添加<code>verify</code>方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordGrantVerifier</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">(<span class="variable">$username</span>, <span class="variable">$password</span>)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">      <span class="variable">$credentials</span> = [</span><br><span class="line">        <span class="string">'email'</span>    =&gt; <span class="variable">$username</span>,</span><br><span class="line">        <span class="string">'password'</span> =&gt; <span class="variable">$password</span>,</span><br><span class="line">      ];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Auth::once(<span class="variable">$credentials</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> Auth::user()-&gt;id;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>拷贝<code>vendor/lucadegasperi/oauth2-server-laravel/database/migrations</code>到自己工程的<code>database/migrations</code>下</p>
<h3 id="u521B_u5EFA_u4E00_u4E2AOAuth_u5BA2_u6237_u7AEF"><a href="#u521B_u5EFA_u4E00_u4E2AOAuth_u5BA2_u6237_u7AEF" class="headerlink" title="创建一个OAuth客户端"></a>创建一个OAuth客户端</h3><p>拷贝<code>vendor/laravel/lumen-framework/config/app.php</code>到<br><code>config/app.php</code>，添加<code>client_id</code>与<code>client_secret</code>的设置<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line"></span><br><span class="line">    <span class="string">'key'</span> =&gt; env(<span class="string">'APP_KEY'</span>, <span class="string">'SomeRandomString!!!'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'cipher'</span> =&gt; <span class="string">'AES-256-CBC'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">'locale'</span> =&gt; env(<span class="string">'APP_LOCALE'</span>, <span class="string">'en'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'fallback_locale'</span> =&gt; env(<span class="string">'APP_FALLBACK_LOCALE'</span>, <span class="string">'en'</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="string">'client_id'</span> =&gt; env(<span class="string">'CLIENT_ID'</span>, <span class="string">'bibihub'</span>),</span><br><span class="line"></span><br><span class="line">    <span class="string">'client_secret'</span> =&gt; env(<span class="string">'CLIENT_SECRET'</span>, <span class="string">'B1B1Hu8!'</span>),</span><br><span class="line"></span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>加入到配置中<code>bootstrap\app.php</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app-&#62;configure(&#39;api&#39;);&#10;$app-&#62;configure(&#39;app&#39;);&#10;$app-&#62;configure(&#39;oauth2&#39;);</span><br></pre></td></tr></table></figure></p>
<p>创建一个<code>seed</code>文件<code>database/seeds/OAuthSeeder.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OAuthSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$config</span> = app()-&gt;make(<span class="string">'config'</span>);</span><br><span class="line"></span><br><span class="line">        app(<span class="string">'db'</span>)-&gt;table(<span class="string">"oauth_clients"</span>)-&gt;delete();</span><br><span class="line"></span><br><span class="line">        app(<span class="string">'db'</span>)-&gt;table(<span class="string">"oauth_clients"</span>)-&gt;insert([</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="variable">$config</span>-&gt;get(<span class="string">'app.client_id'</span>),</span><br><span class="line">            <span class="string">'secret'</span> =&gt; <span class="variable">$config</span>-&gt;get(<span class="string">'app.client_secret'</span>),</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'Lumen-Api-Starter'</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编辑<code>database/seeds/DatabaseSeeder.php</code>文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    Model::unguard();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$this</span>-&gt;call(<span class="string">'OAuthSeeder'</span>); <span class="comment">#Add</span></span><br><span class="line"></span><br><span class="line">    Model::reguard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="u521B_u5EFAuser_u5BF9_u8C61_uFF0C_u53CA_u6570_u636E_u5E93"><a href="#u521B_u5EFAuser_u5BF9_u8C61_uFF0C_u53CA_u6570_u636E_u5E93" class="headerlink" title="创建user对象，及数据库"></a>创建user对象，及数据库</h3><p>新建<code>app\User.php</code>，创建<code>User Model</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Authenticatable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Passwords</span>\<span class="title">CanResetPassword</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Authenticatable</span> <span class="title">as</span> <span class="title">AuthenticatableContract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">CanResetPassword</span> <span class="title">as</span> <span class="title">CanResetPasswordContract</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> <span class="keyword">implements</span> <span class="title">AuthenticatableContract</span>, <span class="title">CanResetPasswordContract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Authenticatable</span>, <span class="title">CanResetPassword</span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The database table used by the model.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">'users'</span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The attributes that are mass assignable.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> array</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$fillable</span> = [<span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'password'</span>];</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The attributes excluded from the model's JSON form.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> array</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hidden</span> = [<span class="string">'password'</span>, <span class="string">'remember_token'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时创建一个<code>migration</code>文件，在工程的根路径下执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:migration create_users_table</span><br></pre></td></tr></table></figure></p>
<p>命令执行完后，<code>database\migrations\yyyy_MM_dd_hhmmss_ create_users_table.php</code>文件会生成，编辑它<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span><span class="params">(Blueprint <span class="variable">$table</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$table</span>-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">'email'</span>)-&gt;unique();</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">'password'</span>, <span class="number">60</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;rememberToken();</span><br><span class="line">        <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    Schema::drop(<span class="string">'users'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于我们用了<code>Schema</code>这个<code>Facade</code>，所以我们需要修改我们的启动项<code>bootstrap\app.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $app-&gt;withFacades();</span></span><br><span class="line"><span class="comment"># $app-&gt;withEloquent();</span></span><br><span class="line"><span class="variable">$app</span>-&gt;withFacades();</span><br><span class="line"><span class="variable">$app</span>-&gt;withEloquent();</span><br></pre></td></tr></table></figure></p>
<p>创建<code>database/seeds/UserSeeder.php</code>文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        app(<span class="string">'db'</span>)-&gt;table(<span class="string">'users'</span>)-&gt;delete();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> = app()-&gt;make(<span class="string">'App\User'</span>);</span><br><span class="line">        <span class="variable">$hasher</span> = app()-&gt;make(<span class="string">'hash'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span>-&gt;fill([</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'BiBiHub'</span>,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'toadgg@bibihub.com'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="variable">$hasher</span>-&gt;make(<span class="string">'123456'</span>)</span><br><span class="line">        ]);</span><br><span class="line">        <span class="variable">$user</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编辑<code>database/seeds/DatabaseSeeder.php</code>文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    Model::unguard();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$this</span>-&gt;call(<span class="string">'OAuthSeeder'</span>); </span><br><span class="line">    <span class="variable">$this</span>-&gt;call(<span class="string">'UserSeeder'</span>);<span class="comment">#Add</span></span><br><span class="line">    </span><br><span class="line">    Model::reguard();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在工程的根路径下，执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer dump-autoload &amp;&amp; php artisan migrate &amp;&amp; php artisan db:seed</span><br></pre></td></tr></table></figure></p>
<p>这样，我们需要用的表，和基础数据就准备好了</p>
<h2 id="dingoapi__u4E0E_oauth2-server-laravel__u8FDB_u884C_u6574_u5408"><a href="#dingoapi__u4E0E_oauth2-server-laravel__u8FDB_u884C_u6574_u5408" class="headerlink" title="dingoapi 与 oauth2-server-laravel 进行整合"></a><a href="http://github.com/dingo/api" target="_blank" rel="external">dingoapi</a> 与 <a href="http://github.com/lucadegasperi/oauth2-server-laravel" target="_blank" rel="external">oauth2-server-laravel</a> 进行整合</h2><p>再次编辑<code>bootstrap\app.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app(<span class="string">'Dingo\Api\Auth\Auth'</span>)-&gt;extend(<span class="string">'oauth'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$app</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$provider</span> = <span class="keyword">new</span> Dingo\Api\Auth\Provider\OAuth2(<span class="variable">$app</span>[<span class="string">'oauth2-server.authorizer'</span>]-&gt;getChecker());</span><br><span class="line"></span><br><span class="line">    <span class="variable">$provider</span>-&gt;setUserResolver(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$id</span>)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Logic to return a user by their ID.</span></span><br><span class="line">        <span class="keyword">return</span> App\User::find(<span class="variable">$id</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$provider</span>-&gt;setClientResolver(<span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$id</span>)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Logic to return a client by their ID.</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$provider</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>编辑<code>app\Http\routes.php</code>文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$app</span>-&gt;post(<span class="string">'oauth/access_token'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response()-&gt;json(app(<span class="string">'oauth2-server.authorizer'</span>)-&gt;issueAccessToken());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$api</span> = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$api</span>-&gt;version(<span class="string">'v1'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'api.auth'</span>], <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$api</span>)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$api</span>-&gt;get(<span class="string">'users/~me'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = app(<span class="string">'Dingo\Api\Auth\Auth'</span>)-&gt;user();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$user</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="u9A8C_u8BC1_u6574_u5408_u662F_u5426_u6210_u529F"><a href="#u9A8C_u8BC1_u6574_u5408_u662F_u5426_u6210_u529F" class="headerlink" title="验证整合是否成功"></a>验证整合是否成功</h2><p>由于鉴权操作需要用到SESSION，我们再次修改<code>.env</code>文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#CACHE_DRIVER=memcached&#10;#SESSION_DRIVER=memcached&#10;CACHE_DRIVER=array&#10;SESSION_DRIVER=cookie</span><br></pre></td></tr></table></figure></p>
<p>下面我们直接访问<code>http://localhost:8000/api/users/~me</code>，返回401错误页面，意思是这个接口需要用户认证<br><img src="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-401.png" alt="用户没有授权"></p>
<p>进行用户鉴权<code>http://localhost:8000/oauth/access_token</code>，发送post请求，<code>grant_type</code>是我们之前定义的，这里用<code>password</code>的形式，请求成功后，我们可以拿到<code>access_token</code><br><img src="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-oauth.png" alt="用户授权得到access_token"></p>
<p>再次访问<code>http://localhost:8000/api/users/~me</code>，添加<code>Authorization</code>Header，值为<code>Bearer {access_token}</code>，<code>{access_token}</code> 就是我们刚才拿到，注意<code>Bearer</code>与<code>access_token</code>之间是有一个空格到<br><img src="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-oauth-pass.png" alt="授权用户访问接口"></p>
<p>试验一下版本号是否有效，依然是访问<code>http://localhost:8000/api/users/~me</code>，再添加一个<code>Accept</code>Header，值为<code>application/vnd.bibihub.v2+json</code>，这个对应配置文件，细节请参考<a href="http://github.com/dingo/api" target="_blank" rel="external">dingoapi</a>的官方文档<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">API_STANDARDS_TREE=vnd</span><br><span class="line">API_VENDOR=bibihub</span><br></pre></td></tr></table></figure></p>
<p><img src="http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/postman-version-unknown.png" alt="授权用户访问不存在的version接口"></p>
<hr>
<blockquote>
<p>完整的项目我已经提交到了<a href="http://github.com/toadgg/lumen-api-starter" target="_blank" rel="external">github</a>上面，<a href="http://github.com/toadgg/lumen-api-starter" target="_blank" rel="external">toadgg/lumen-api-starter</a>，有什么问题可以在上面交流</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.bibihub.com/php/lumen-mobile-api-oauth-2-authentication/" data-id="cijzgf4pe000lnes6spn9arb7" class="article-share-link">分享到</a>
      
        <a href="http://www.bibihub.com/php/lumen-mobile-api-oauth-2-authentication/#disqus_thread" class="article-comment-link">评论</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/api/">api</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lumen/">lumen</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oauth2/">oauth2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/angularjs/how-to-filter-angular-ng-repeat-to-use-ranges-of-dates/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">AngularJS中的ng-repeat按照时间范围过滤数据</div>
    </a>
  
</nav>


  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul id="recent-post" class="">
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/php/lumen-mobile-api-oauth-2-authentication/" class="thumbnail">
  
    <span style="background-image:url(http://bibihub.oss-cn-hangzhou.aliyuncs.com/php/remote-api.png)" alt="基于Lumen搭建一个OAUTH2认证的API框架" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/php/">php</a></p>
              <p class="item-title"><a href="/php/lumen-mobile-api-oauth-2-authentication/" class="title">基于Lumen搭建一个OAUTH2认证的API框架</a></p>
              <p class="item-date"><time datetime="2016-01-29T08:55:02.000Z" itemprop="datePublished">2016-01-29</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/angularjs/how-to-filter-angular-ng-repeat-to-use-ranges-of-dates/" class="thumbnail">
  
    <span style="background-image:url(http://bibihub.oss-cn-hangzhou.aliyuncs.com/angularjs/angularjs-logo.png)" alt="AngularJS中的ng-repeat按照时间范围过滤数据" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/angularjs/">angularjs</a></p>
              <p class="item-title"><a href="/angularjs/how-to-filter-angular-ng-repeat-to-use-ranges-of-dates/" class="title">AngularJS中的ng-repeat按照时间范围过滤数据</a></p>
              <p class="item-date"><time datetime="2016-01-28T10:05:57.000Z" itemprop="datePublished">2016-01-28</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/linux/setup-pptp-vpn-server-on-centos-7/" class="thumbnail">
  
    <span style="background-image:url(http://bibihub.oss-cn-hangzhou.aliyuncs.com/vultr/gfw-small.png)" alt="如何在Linux(centos7)下搭建一个VPN服务器" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/linux/">linux</a></p>
              <p class="item-title"><a href="/linux/setup-pptp-vpn-server-on-centos-7/" class="title">如何在Linux(centos7)下搭建一个VPN服务器</a></p>
              <p class="item-date"><time datetime="2016-01-27T07:29:24.000Z" itemprop="datePublished">2016-01-27</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/nginx/nginx-apache-tomcat-configuration/" class="thumbnail">
  
    <span style="background-image:url(http://bibihub.oss-cn-hangzhou.aliyuncs.com/nginx%2Fnginx-logo-360x360.png)" alt="利用nginx改变web应用的端口号" class="thumbnail-image"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/nginx/">nginx</a></p>
              <p class="item-title"><a href="/nginx/nginx-apache-tomcat-configuration/" class="title">利用nginx改变web应用的端口号</a></p>
              <p class="item-date"><time datetime="2015-10-25T06:04:40.000Z" itemprop="datePublished">2015-10-25</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/angularjs/">angularjs</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/angularjs/">angularjs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/api/">api</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lumen/">lumen</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth2/">oauth2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pptp/">pptp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vpn/">vpn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/">vps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/angularjs/" style="font-size: 10px;">angularjs</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/lumen/" style="font-size: 10px;">lumen</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/oauth2/" style="font-size: 10px;">oauth2</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/pptp/" style="font-size: 10px;">pptp</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/vpn/" style="font-size: 10px;">vpn</a> <a href="/tags/vps/" style="font-size: 10px;">vps</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 张晓亮<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/toadgg">BiBiHub</a>
    </div>
  </div>
</footer>
    

<script>
  var disqus_shortname = 'bibihub';
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

    _st('install','bU-EtxangMESMfCQtn4k','2.0.0');
  </script>



<script>
  (function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>



 <script src="//ajax.useso.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>